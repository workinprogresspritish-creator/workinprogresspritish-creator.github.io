<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1a1a2e">
<title>RunTracker</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0f0f23;
  --surface: #1a1a2e;
  --surface2: #25254a;
  --accent: #00d4aa;
  --accent2: #00b894;
  --danger: #e74c3c;
  --warning: #f39c12;
  --text: #e8e8f0;
  --text-dim: #8888aa;
  --green: #00e676;
  --blue: #448aff;
  --red: #ff5252;
  --orange: #ff9100;
  --radius: 14px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
}

/* ===== HEADER ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--surface2);
  z-index: 1000;
  flex-shrink: 0;
}

.header h1 {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.unit-toggle {
  background: var(--surface2);
  border: none;
  color: var(--text-dim);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  cursor: pointer;
}
.unit-toggle:active { background: var(--accent); color: var(--bg); }

/* ===== TABS ===== */
.tab-bar {
  display: flex;
  background: var(--surface);
  border-top: 1px solid var(--surface2);
  padding-bottom: var(--safe-bottom);
  flex-shrink: 0;
  z-index: 1000;
}

.tab-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 10px 0;
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: color 0.2s;
}
.tab-btn svg { width: 22px; height: 22px; }
.tab-btn.active { color: var(--accent); }

/* ===== PANELS ===== */
.panel {
  display: none;
  flex: 1;
  overflow: hidden;
  flex-direction: column;
}
.panel.active { display: flex; }

/* ===== PLAN TAB ===== */
#plan-panel {
  position: relative;
}

#map {
  flex: 1;
  z-index: 1;
}

.map-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  z-index: 500;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.map-overlay > * { pointer-events: auto; }

.search-box {
  display: flex;
  gap: 8px;
}

.search-box input {
  flex: 1;
  padding: 12px 16px;
  border-radius: var(--radius);
  border: 1px solid var(--surface2);
  background: var(--surface);
  color: var(--text);
  font-size: 15px;
  outline: none;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.search-box input::placeholder { color: var(--text-dim); }
.search-box input:focus { border-color: var(--accent); }

.search-box button {
  padding: 12px 16px;
  border-radius: var(--radius);
  border: none;
  background: var(--accent);
  color: var(--bg);
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.search-results {
  background: var(--surface);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  max-height: 200px;
  overflow-y: auto;
  display: none;
}
.search-results.show { display: block; }

.search-result-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--surface2);
  cursor: pointer;
  font-size: 14px;
}
.search-result-item:active { background: var(--surface2); }
.search-result-item:last-child { border-bottom: none; }

.waypoint-info {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 12px 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  font-size: 13px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

.wp-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}
.wp-badge.start { background: rgba(0,230,118,0.2); color: var(--green); }
.wp-badge.cp { background: rgba(68,138,255,0.2); color: var(--blue); }
.wp-badge.end { background: rgba(255,82,82,0.2); color: var(--red); }
.wp-badge.set { opacity: 1; }
.wp-badge.unset { opacity: 0.4; }

.wp-next-label {
  font-size: 12px;
  color: var(--accent);
  font-weight: 600;
}

.map-bottom-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 500;
  padding: 10px;
  display: flex;
  gap: 8px;
}

.map-bottom-bar .route-info {
  flex: 1;
  background: var(--surface);
  border-radius: var(--radius);
  padding: 14px 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  gap: 12px;
}

.route-info .dist-val {
  font-size: 22px;
  font-weight: 700;
  color: var(--accent);
}
.route-info .dist-label {
  font-size: 12px;
  color: var(--text-dim);
}

.btn-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.btn-icon svg { width: 22px; height: 22px; }

.btn-clear {
  background: var(--danger);
  color: white;
}
.btn-locate {
  background: var(--surface);
  color: var(--accent);
}
.btn-clear:active, .btn-locate:active { transform: scale(0.92); }

/* ===== RUN TAB ===== */
#run-panel {
  position: relative;
}

#run-map {
  flex: 1;
  z-index: 1;
}

.run-stats-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  z-index: 500;
  padding: 10px;
  pointer-events: none;
}
.run-stats-overlay > * { pointer-events: auto; }

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.stat-card {
  background: rgba(26,26,46,0.92);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius);
  padding: 12px 14px;
  border: 1px solid var(--surface2);
}

.stat-card.wide {
  grid-column: 1 / -1;
}

.stat-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}
.stat-value.speed { color: var(--accent); }
.stat-value.distance { color: var(--orange); }
.stat-value.time { color: var(--blue); }
.stat-value.pace { color: var(--green); }

.stat-unit {
  font-size: 13px;
  font-weight: 400;
  color: var(--text-dim);
  margin-left: 4px;
}

.checkpoint-alert {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  z-index: 600;
  background: var(--accent);
  color: var(--bg);
  padding: 20px 32px;
  border-radius: 20px;
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  box-shadow: 0 8px 40px rgba(0,212,170,0.4);
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.checkpoint-alert.show {
  transform: translate(-50%, -50%) scale(1);
}

.run-controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 500;
  padding: 16px;
  display: flex;
  justify-content: center;
  gap: 16px;
  align-items: center;
}

.btn-run {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  border: 3px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 6px 30px rgba(0,0,0,0.5);
  transition: transform 0.15s;
}
.btn-run:active { transform: scale(0.9); }
.btn-run svg { width: 28px; height: 28px; }

.btn-start {
  background: var(--green);
  border-color: rgba(255,255,255,0.2);
  color: var(--bg);
}
.btn-pause {
  background: var(--warning);
  border-color: rgba(255,255,255,0.2);
  color: var(--bg);
}
.btn-resume {
  background: var(--green);
  border-color: rgba(255,255,255,0.2);
  color: var(--bg);
}
.btn-stop {
  width: 56px;
  height: 56px;
  background: var(--danger);
  border-color: rgba(255,255,255,0.2);
  color: white;
}

.no-route-msg {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 500;
  background: var(--surface);
  padding: 24px;
  border-radius: var(--radius);
  text-align: center;
  max-width: 280px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.5);
}
.no-route-msg p { color: var(--text-dim); margin-top: 8px; font-size: 14px; }

/* ===== HISTORY TAB ===== */
#history-panel {
  overflow-y: auto;
  padding: 16px;
  gap: 12px;
}

.history-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  color: var(--text-dim);
  text-align: center;
  gap: 12px;
}
.history-empty svg { width: 48px; height: 48px; opacity: 0.3; }

.run-card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 16px;
  border: 1px solid var(--surface2);
}

.run-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.run-card-date {
  font-size: 14px;
  font-weight: 600;
}
.run-card-delete {
  background: none;
  border: none;
  color: var(--text-dim);
  cursor: pointer;
  padding: 4px;
}
.run-card-delete:active { color: var(--danger); }

.run-card-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

.run-card-stat-label {
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
}
.run-card-stat-value {
  font-size: 18px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
}

.run-card-splits {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--surface2);
}
.run-card-splits h4 {
  font-size: 12px;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 8px;
}

.split-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 13px;
}
.split-label { color: var(--text-dim); }
.split-value { font-weight: 600; font-variant-numeric: tabular-nums; }

/* ===== SUMMARY MODAL ===== */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.modal-overlay.show { display: flex; }

.modal {
  background: var(--surface);
  border-radius: 20px;
  padding: 28px 24px;
  width: 100%;
  max-width: 360px;
  max-height: 80vh;
  overflow-y: auto;
}

.modal h2 {
  font-size: 22px;
  margin-bottom: 20px;
  text-align: center;
}

.modal-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}

.modal-stat {
  text-align: center;
}
.modal-stat .stat-label { margin-bottom: 4px; }
.modal-stat .stat-value { font-size: 24px; }

.modal-splits {
  margin-bottom: 20px;
}
.modal-splits h3 {
  font-size: 14px;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 10px;
}

.modal-actions {
  display: flex;
  gap: 10px;
}

.modal-btn {
  flex: 1;
  padding: 14px;
  border-radius: var(--radius);
  border: none;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
}
.modal-btn-save { background: var(--accent); color: var(--bg); }
.modal-btn-discard { background: var(--surface2); color: var(--text-dim); }
.modal-btn:active { transform: scale(0.97); }

/* ===== LEAFLET OVERRIDES ===== */
.leaflet-control-zoom { display: none !important; }
.leaflet-control-attribution { font-size: 9px !important; }

.marker-label {
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  font-size: 11px;
  font-weight: 700;
  color: white;
  text-shadow: 0 1px 4px rgba(0,0,0,0.8);
  white-space: nowrap;
}

/* ===== ANIMATIONS ===== */
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.15); opacity: 0.7; }
}

.runner-marker {
  animation: pulse 2s infinite;
}

/* ===== GPS STATUS ===== */
.gps-status {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(26,26,46,0.9);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.gps-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-dim);
}
.gps-dot.active { background: var(--green); animation: pulse 2s infinite; }
.gps-dot.error { background: var(--danger); }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <div class="header">
    <h1>RunTracker</h1>
    <button class="unit-toggle" id="unitToggle" onclick="toggleUnits()">km</button>
  </div>

  <!-- Plan Panel -->
  <div class="panel active" id="plan-panel">
    <div id="map"></div>

    <div class="map-overlay">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search location..." autocomplete="off">
        <button onclick="searchLocation()">Go</button>
      </div>
      <div class="search-results" id="searchResults"></div>
      <div class="waypoint-info" id="waypointInfo">
        <span class="wp-next-label" id="wpNextLabel">Tap map to set: Start</span>
        <span class="wp-badge start unset" id="wpStart">Start</span>
        <span class="wp-badge cp unset" id="wpCP1">CP1</span>
        <span class="wp-badge cp unset" id="wpCP2">CP2</span>
        <span class="wp-badge end unset" id="wpEnd">End</span>
      </div>
    </div>

    <div class="map-bottom-bar" id="mapBottomBar">
      <div class="route-info" id="routeInfo" style="display:none">
        <div>
          <div class="dist-val" id="routeDist">0.00</div>
          <div class="dist-label">Planned distance</div>
        </div>
      </div>
      <button class="btn-icon btn-locate" onclick="locateUser()" title="My location">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg>
      </button>
      <button class="btn-icon btn-clear" onclick="clearRoute()" title="Clear route">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>

  <!-- Run Panel -->
  <div class="panel" id="run-panel">
    <div id="run-map"></div>

    <div class="run-stats-overlay" id="runStatsOverlay">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Speed</div>
          <div class="stat-value speed" id="curSpeed">0.0<span class="stat-unit" id="speedUnit">km/h</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Speed</div>
          <div class="stat-value speed" id="avgSpeed">0.0<span class="stat-unit" id="avgSpeedUnit">km/h</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Distance</div>
          <div class="stat-value distance" id="runDist">0.00<span class="stat-unit" id="distUnit">km</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pace</div>
          <div class="stat-value pace" id="runPace">--:--<span class="stat-unit" id="paceUnit">/km</span></div>
        </div>
        <div class="stat-card wide">
          <div class="stat-label">Elapsed Time</div>
          <div class="stat-value time" id="runTime">00:00:00</div>
        </div>
      </div>
    </div>

    <div class="gps-status" id="gpsStatus">
      <span class="gps-dot" id="gpsDot"></span>
      <span id="gpsText">GPS Off</span>
    </div>

    <div class="checkpoint-alert" id="checkpointAlert"></div>

    <div class="no-route-msg" id="noRouteMsg" style="display:none">
      <h3>No Route Set</h3>
      <p>Go to the Plan tab first and set your Start, Checkpoints, and End locations.</p>
    </div>

    <div class="run-controls" id="runControls">
      <button class="btn-run btn-start" id="btnStart" onclick="startRun()">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>
      </button>
    </div>
  </div>

  <!-- History Panel -->
  <div class="panel" id="history-panel">
    <div class="history-empty" id="historyEmpty">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
      <p>No runs yet.<br>Complete a run to see it here.</p>
    </div>
    <div id="historyList"></div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="plan" onclick="switchTab('plan')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
      Plan
    </button>
    <button class="tab-btn" data-tab="run" onclick="switchTab('run')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Run
    </button>
    <button class="tab-btn" data-tab="history" onclick="switchTab('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
      History
    </button>
  </div>
</div>

<!-- Summary Modal -->
<div class="modal-overlay" id="summaryModal">
  <div class="modal">
    <h2>Run Complete!</h2>
    <div class="modal-stats" id="modalStats"></div>
    <div class="modal-splits" id="modalSplits"></div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-discard" onclick="discardRun()">Discard</button>
      <button class="modal-btn modal-btn-save" onclick="saveRun()">Save Run</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =============================================
// STATE
// =============================================
let useMetric = true;
let planMap, runMap;
const waypoints = { start: null, cp1: null, cp2: null, end: null };
const wpOrder = ['start', 'cp1', 'cp2', 'end'];
const wpLabels = { start: 'Start', cp1: 'Checkpoint 1', cp2: 'Checkpoint 2', end: 'End' };
const wpMarkers = {};
let routeLine = null;
let routeDistance = 0;

// Run state
let runState = 'idle'; // idle, running, paused
let watchId = null;
let gpsTrail = [];
let runStartTime = null;
let runElapsed = 0;
let pausedAt = 0;
let timerInterval = null;
let totalDistance = 0;
let currentSpeed = 0;
let avgSpeed = 0;
let runnerMarker = null;
let trailLine = null;
let lastPosition = null;
let lastPositionTime = null;
const reachedCheckpoints = new Set();
let segmentDistances = [];
let segmentTimes = [];
let lastSegmentDist = 0;
let lastSegmentTime = 0;
let completedRunData = null;

// Speed smoothing
const speedBuffer = [];
const SPEED_BUFFER_SIZE = 5;

// =============================================
// MAP SETUP
// =============================================
function initMaps() {
  const defaultCenter = [28.6139, 77.2090]; // Delhi
  const defaultZoom = 13;

  planMap = L.map('map', {
    zoomControl: false,
    attributionControl: true
  }).setView(defaultCenter, defaultZoom);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(planMap);

  planMap.on('click', onMapClick);

  runMap = L.map('run-map', {
    zoomControl: false,
    attributionControl: true
  }).setView(defaultCenter, defaultZoom);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(runMap);
}

// =============================================
// WAYPOINT MANAGEMENT
// =============================================
function getNextWaypoint() {
  for (const key of wpOrder) {
    if (!waypoints[key]) return key;
  }
  return null;
}

function updateWaypointUI() {
  const next = getNextWaypoint();
  const label = document.getElementById('wpNextLabel');

  if (next) {
    label.textContent = 'Tap map: ' + wpLabels[next];
  } else {
    label.textContent = 'Route set!';
  }

  for (const key of wpOrder) {
    const el = document.getElementById(key === 'start' ? 'wpStart' : key === 'cp1' ? 'wpCP1' : key === 'cp2' ? 'wpCP2' : 'wpEnd');
    if (waypoints[key]) {
      el.classList.add('set');
      el.classList.remove('unset');
    } else {
      el.classList.remove('set');
      el.classList.add('unset');
    }
  }
}

function createMarkerIcon(color, label) {
  return L.divIcon({
    className: '',
    html: `<div style="width:32px;height:32px;background:${color};border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;">${label}</div>`,
    iconSize: [32, 32],
    iconAnchor: [16, 16]
  });
}

const markerConfig = {
  start: { color: '#00e676', label: 'S' },
  cp1: { color: '#448aff', label: '1' },
  cp2: { color: '#448aff', label: '2' },
  end: { color: '#ff5252', label: 'E' }
};

function onMapClick(e) {
  const next = getNextWaypoint();
  if (!next) return;

  waypoints[next] = [e.latlng.lat, e.latlng.lng];
  const cfg = markerConfig[next];

  if (wpMarkers[next]) {
    planMap.removeLayer(wpMarkers[next]);
  }

  wpMarkers[next] = L.marker(e.latlng, {
    icon: createMarkerIcon(cfg.color, cfg.label),
    draggable: true
  }).addTo(planMap);

  wpMarkers[next].on('dragend', function(ev) {
    const pos = ev.target.getLatLng();
    waypoints[next] = [pos.lat, pos.lng];
    calculateRoute();
  });

  updateWaypointUI();

  if (!getNextWaypoint()) {
    calculateRoute();
  }
}

function placeWaypointAt(latlng) {
  onMapClick({ latlng: L.latLng(latlng[0], latlng[1]) });
}

// =============================================
// ROUTING (OSRM)
// =============================================
async function calculateRoute() {
  const points = wpOrder.map(k => waypoints[k]).filter(Boolean);
  if (points.length < 2) return;

  const coords = points.map(p => `${p[1]},${p[0]}`).join(';');
  const url = `https://router.project-osrm.org/route/v1/foot/${coords}?overview=full&geometries=geojson`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();

    if (data.routes && data.routes.length > 0) {
      const route = data.routes[0];
      const geojson = route.geometry;

      if (routeLine) planMap.removeLayer(routeLine);

      routeLine = L.geoJSON(geojson, {
        style: { color: '#00d4aa', weight: 4, opacity: 0.8, dashArray: '8 4' }
      }).addTo(planMap);

      routeDistance = route.distance;
      updateRouteDisplay();

      const bounds = routeLine.getBounds().pad(0.1);
      planMap.fitBounds(bounds);
    }
  } catch (err) {
    console.error('Route error:', err);
  }
}

function updateRouteDisplay() {
  const el = document.getElementById('routeInfo');
  const distEl = document.getElementById('routeDist');

  if (routeDistance > 0) {
    el.style.display = 'flex';
    const d = useMetric ? (routeDistance / 1000).toFixed(2) + ' km' : (routeDistance / 1609.34).toFixed(2) + ' mi';
    distEl.textContent = d;
  } else {
    el.style.display = 'none';
  }
}

function clearRoute() {
  for (const key of wpOrder) {
    if (wpMarkers[key]) {
      planMap.removeLayer(wpMarkers[key]);
      delete wpMarkers[key];
    }
    waypoints[key] = null;
  }
  if (routeLine) {
    planMap.removeLayer(routeLine);
    routeLine = null;
  }
  routeDistance = 0;
  updateRouteDisplay();
  updateWaypointUI();
}

// =============================================
// SEARCH
// =============================================
let searchTimeout;

document.getElementById('searchInput').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    if (this.value.length >= 3) searchLocation();
  }, 500);
});

document.getElementById('searchInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') searchLocation();
});

async function searchLocation() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) return;

  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`;

  try {
    const resp = await fetch(url, {
      headers: { 'Accept-Language': 'en' }
    });
    const results = await resp.json();

    const container = document.getElementById('searchResults');
    container.innerHTML = '';

    if (results.length === 0) {
      container.innerHTML = '<div class="search-result-item">No results found</div>';
      container.classList.add('show');
      return;
    }

    results.forEach(r => {
      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.textContent = r.display_name.substring(0, 80);
      item.onclick = () => {
        const lat = parseFloat(r.lat);
        const lng = parseFloat(r.lon);
        planMap.setView([lat, lng], 15);
        container.classList.remove('show');
        document.getElementById('searchInput').value = '';

        const next = getNextWaypoint();
        if (next) {
          placeWaypointAt([lat, lng]);
        }
      };
      container.appendChild(item);
    });

    container.classList.add('show');
  } catch (err) {
    console.error('Search error:', err);
  }
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.search-box') && !e.target.closest('.search-results')) {
    document.getElementById('searchResults').classList.remove('show');
  }
});

// =============================================
// GEOLOCATION
// =============================================
function locateUser() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    pos => { planMap.setView([pos.coords.latitude, pos.coords.longitude], 16); },
    () => {},
    { enableHighAccuracy: true }
  );
}

// =============================================
// TABS
// =============================================
function switchTab(tab) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tab + '-panel').classList.add('active');
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

  if (tab === 'plan') {
    setTimeout(() => planMap.invalidateSize(), 100);
  } else if (tab === 'run') {
    setTimeout(() => runMap.invalidateSize(), 100);
    setupRunTab();
  } else if (tab === 'history') {
    renderHistory();
  }
}

// =============================================
// RUN TAB SETUP
// =============================================
function setupRunTab() {
  const hasRoute = wpOrder.every(k => waypoints[k]);
  document.getElementById('noRouteMsg').style.display = hasRoute ? 'none' : 'block';
  document.getElementById('runStatsOverlay').style.display = hasRoute || runState !== 'idle' ? '' : 'none';

  if (hasRoute && runState === 'idle') {
    // Copy route to run map
    runMap.eachLayer(layer => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.GeoJSON) {
        runMap.removeLayer(layer);
      }
    });

    for (const key of wpOrder) {
      const cfg = markerConfig[key];
      L.marker(waypoints[key], {
        icon: createMarkerIcon(cfg.color, cfg.label)
      }).addTo(runMap);
    }

    // Add route line
    if (routeDistance > 0) {
      calculateRunRoute();
    }

    const bounds = L.latLngBounds(wpOrder.map(k => waypoints[k]));
    runMap.fitBounds(bounds.pad(0.15));
  }
}

async function calculateRunRoute() {
  const points = wpOrder.map(k => waypoints[k]).filter(Boolean);
  if (points.length < 2) return;

  const coords = points.map(p => `${p[1]},${p[0]}`).join(';');
  const url = `https://router.project-osrm.org/route/v1/foot/${coords}?overview=full&geometries=geojson`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.routes && data.routes.length > 0) {
      L.geoJSON(data.routes[0].geometry, {
        style: { color: '#00d4aa', weight: 3, opacity: 0.5, dashArray: '6 4' }
      }).addTo(runMap);
    }
  } catch (err) {}
}

// =============================================
// RUN CONTROLS
// =============================================
function startRun() {
  if (!navigator.geolocation) {
    alert('GPS not available on this device.');
    return;
  }

  const hasRoute = wpOrder.every(k => waypoints[k]);
  if (!hasRoute) {
    alert('Set all 4 waypoints in Plan tab first.');
    return;
  }

  runState = 'running';
  gpsTrail = [];
  totalDistance = 0;
  currentSpeed = 0;
  avgSpeed = 0;
  runStartTime = Date.now();
  runElapsed = 0;
  pausedAt = 0;
  lastPosition = null;
  lastPositionTime = null;
  reachedCheckpoints.clear();
  speedBuffer.length = 0;
  segmentDistances = [0, 0, 0];
  segmentTimes = [0, 0, 0];
  lastSegmentDist = 0;
  lastSegmentTime = Date.now();

  if (trailLine) runMap.removeLayer(trailLine);
  trailLine = L.polyline([], { color: '#ff9100', weight: 4, opacity: 0.9 }).addTo(runMap);

  if (runnerMarker) runMap.removeLayer(runnerMarker);
  runnerMarker = L.marker([0, 0], {
    icon: L.divIcon({
      className: 'runner-marker',
      html: '<div style="width:20px;height:20px;background:#00d4aa;border-radius:50%;border:3px solid white;box-shadow:0 0 12px rgba(0,212,170,0.6);"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    })
  }).addTo(runMap);

  startGPS();
  startTimer();
  updateRunControls();
  setGPSStatus('active', 'Acquiring...');
}

function pauseRun() {
  runState = 'paused';
  pausedAt = Date.now();
  stopGPS();
  stopTimer();
  updateRunControls();
  setGPSStatus('', 'Paused');
}

function resumeRun() {
  runState = 'running';
  const pauseDuration = Date.now() - pausedAt;
  runStartTime += pauseDuration;
  lastSegmentTime += pauseDuration;
  startGPS();
  startTimer();
  updateRunControls();
  setGPSStatus('active', 'Tracking');
}

function stopRun() {
  if (runState === 'idle') return;
  if (totalDistance < 1 && runElapsed < 5000) {
    if (!confirm('Run is very short. Stop anyway?')) return;
  }

  // Record final segment
  finalizeSegments();

  runState = 'idle';
  stopGPS();
  stopTimer();
  updateRunControls();
  setGPSStatus('', 'GPS Off');

  showSummary();
}

function updateRunControls() {
  const container = document.getElementById('runControls');

  if (runState === 'idle') {
    container.innerHTML = `
      <button class="btn-run btn-start" onclick="startRun()">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>
      </button>`;
  } else if (runState === 'running') {
    container.innerHTML = `
      <button class="btn-run btn-stop" onclick="stopRun()">
        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
      <button class="btn-run btn-pause" onclick="pauseRun()">
        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
      </button>`;
  } else if (runState === 'paused') {
    container.innerHTML = `
      <button class="btn-run btn-stop" onclick="stopRun()">
        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
      <button class="btn-run btn-resume" onclick="resumeRun()">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6,3 20,12 6,21"/></svg>
      </button>`;
  }
}

// =============================================
// GPS TRACKING
// =============================================
function startGPS() {
  watchId = navigator.geolocation.watchPosition(
    onGPSUpdate,
    onGPSError,
    {
      enableHighAccuracy: true,
      maximumAge: 2000,
      timeout: 10000
    }
  );
}

function stopGPS() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
}

function onGPSUpdate(position) {
  const { latitude, longitude, speed, accuracy } = position.coords;
  const now = Date.now();

  setGPSStatus('active', accuracy < 20 ? 'GPS Locked' : `~${Math.round(accuracy)}m`);

  // Ignore inaccurate readings
  if (accuracy > 50) return;

  const latlng = [latitude, longitude];

  // Update runner position
  runnerMarker.setLatLng(latlng);
  runMap.panTo(latlng);

  // Calculate distance from last point
  if (lastPosition) {
    const dist = haversineDistance(lastPosition, latlng);

    // Filter out GPS jitter (ignore movements < 2m or > 100m in one reading)
    if (dist >= 2 && dist < 100) {
      totalDistance += dist;
      gpsTrail.push(latlng);
      trailLine.addLatLng(latlng);

      // Calculate current speed
      const timeDelta = (now - lastPositionTime) / 1000;
      if (timeDelta > 0) {
        let calcSpeed = dist / timeDelta; // m/s

        // Use GPS speed if available and reasonable
        if (speed !== null && speed >= 0 && speed < 15) {
          calcSpeed = speed;
        }

        speedBuffer.push(calcSpeed);
        if (speedBuffer.length > SPEED_BUFFER_SIZE) speedBuffer.shift();

        currentSpeed = speedBuffer.reduce((a, b) => a + b, 0) / speedBuffer.length;
      }
    }
  } else {
    gpsTrail.push(latlng);
    trailLine.addLatLng(latlng);
  }

  lastPosition = latlng;
  lastPositionTime = now;

  // Check checkpoints
  checkCheckpoints(latlng);

  // Update display
  updateRunDisplay();
}

function onGPSError(err) {
  console.warn('GPS error:', err);
  setGPSStatus('error', err.code === 1 ? 'Permission Denied' : 'GPS Error');
}

function setGPSStatus(state, text) {
  const dot = document.getElementById('gpsDot');
  const label = document.getElementById('gpsText');
  dot.className = 'gps-dot' + (state ? ' ' + state : '');
  label.textContent = text;
}

// =============================================
// DISTANCE / SPEED CALCULATIONS
// =============================================
function haversineDistance(coord1, coord2) {
  const R = 6371000; // meters
  const dLat = toRad(coord2[0] - coord1[0]);
  const dLng = toRad(coord2[1] - coord1[1]);
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(coord1[0])) * Math.cos(toRad(coord2[0])) * Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function toRad(deg) { return deg * Math.PI / 180; }

// =============================================
// CHECKPOINT DETECTION
// =============================================
function checkCheckpoints(latlng) {
  const checkOrder = ['start', 'cp1', 'cp2', 'end'];
  const RADIUS = 50; // meters

  for (const key of checkOrder) {
    if (reachedCheckpoints.has(key)) continue;

    const wp = waypoints[key];
    if (!wp) continue;

    const dist = haversineDistance(latlng, wp);
    if (dist <= RADIUS) {
      reachedCheckpoints.add(key);

      // Record segment data
      const idx = checkOrder.indexOf(key);
      if (idx > 0) {
        const segIdx = idx - 1;
        segmentDistances[segIdx] = totalDistance - lastSegmentDist;
        segmentTimes[segIdx] = Date.now() - lastSegmentTime;
      }
      lastSegmentDist = totalDistance;
      lastSegmentTime = Date.now();

      showCheckpointAlert(wpLabels[key]);

      // Vibrate
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      break;
    }
  }
}

function finalizeSegments() {
  // Fill in remaining segments
  const checkOrder = ['start', 'cp1', 'cp2', 'end'];
  let lastReachedIdx = -1;
  for (let i = checkOrder.length - 1; i >= 0; i--) {
    if (reachedCheckpoints.has(checkOrder[i])) {
      lastReachedIdx = i;
      break;
    }
  }

  if (lastReachedIdx >= 0 && lastReachedIdx < 3) {
    segmentDistances[lastReachedIdx] = totalDistance - lastSegmentDist;
    segmentTimes[lastReachedIdx] = Date.now() - lastSegmentTime;
  }
}

function showCheckpointAlert(name) {
  const el = document.getElementById('checkpointAlert');
  el.textContent = name + ' Reached!';
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

// =============================================
// TIMER
// =============================================
function startTimer() {
  timerInterval = setInterval(updateRunDisplay, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function updateRunDisplay() {
  if (runState === 'idle') return;

  const elapsed = Date.now() - runStartTime;
  runElapsed = elapsed;

  // Time
  document.getElementById('runTime').textContent = formatTime(elapsed);

  // Distance
  const dist = useMetric ? totalDistance / 1000 : totalDistance / 1609.34;
  document.getElementById('runDist').innerHTML = dist.toFixed(2) + `<span class="stat-unit">${useMetric ? 'km' : 'mi'}</span>`;

  // Current speed
  const speedMs = currentSpeed;
  const speedDisplay = useMetric ? speedMs * 3.6 : speedMs * 2.23694;
  document.getElementById('curSpeed').innerHTML = speedDisplay.toFixed(1) + `<span class="stat-unit">${useMetric ? 'km/h' : 'mph'}</span>`;

  // Average speed
  const elapsedSec = elapsed / 1000;
  if (elapsedSec > 0 && totalDistance > 0) {
    const avgMs = totalDistance / elapsedSec;
    const avgDisplay = useMetric ? avgMs * 3.6 : avgMs * 2.23694;
    document.getElementById('avgSpeed').innerHTML = avgDisplay.toFixed(1) + `<span class="stat-unit">${useMetric ? 'km/h' : 'mph'}</span>`;
  }

  // Pace (min per km or min per mile)
  if (totalDistance > 100) {
    const paceBase = useMetric ? 1000 : 1609.34;
    const paceSeconds = (elapsed / 1000) / (totalDistance / paceBase);
    const paceMins = Math.floor(paceSeconds / 60);
    const paceSecs = Math.floor(paceSeconds % 60);
    document.getElementById('runPace').innerHTML =
      `${paceMins}:${String(paceSecs).padStart(2, '0')}<span class="stat-unit">/${useMetric ? 'km' : 'mi'}</span>`;
  }

  // Update unit labels
  document.getElementById('speedUnit').textContent = useMetric ? 'km/h' : 'mph';
  document.getElementById('avgSpeedUnit').textContent = useMetric ? 'km/h' : 'mph';
  document.getElementById('distUnit').textContent = useMetric ? 'km' : 'mi';
  document.getElementById('paceUnit').textContent = useMetric ? '/km' : '/mi';
}

function formatTime(ms) {
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
}

// =============================================
// SUMMARY
// =============================================
function showSummary() {
  const elapsed = runElapsed;
  const dist = useMetric ? totalDistance / 1000 : totalDistance / 1609.34;
  const unit = useMetric ? 'km' : 'mi';
  const speedUnit = useMetric ? 'km/h' : 'mph';
  const elapsedSec = elapsed / 1000;
  const avgSpd = elapsedSec > 0 ? (useMetric ? (totalDistance / elapsedSec) * 3.6 : (totalDistance / elapsedSec) * 2.23694) : 0;

  let paceStr = '--:--';
  if (totalDistance > 100) {
    const paceBase = useMetric ? 1000 : 1609.34;
    const paceSeconds = elapsedSec / (totalDistance / paceBase);
    const paceMins = Math.floor(paceSeconds / 60);
    const paceSecs = Math.floor(paceSeconds % 60);
    paceStr = `${paceMins}:${String(paceSecs).padStart(2, '0')}`;
  }

  completedRunData = {
    date: new Date().toISOString(),
    distanceM: totalDistance,
    elapsed,
    avgSpeed: avgSpd,
    trail: gpsTrail,
    segments: segmentDistances.map((d, i) => ({
      distance: d,
      time: segmentTimes[i]
    }))
  };

  const statsHtml = `
    <div class="modal-stat">
      <div class="stat-label">Distance</div>
      <div class="stat-value distance">${dist.toFixed(2)} <span class="stat-unit">${unit}</span></div>
    </div>
    <div class="modal-stat">
      <div class="stat-label">Time</div>
      <div class="stat-value time">${formatTime(elapsed)}</div>
    </div>
    <div class="modal-stat">
      <div class="stat-label">Avg Speed</div>
      <div class="stat-value speed">${avgSpd.toFixed(1)} <span class="stat-unit">${speedUnit}</span></div>
    </div>
    <div class="modal-stat">
      <div class="stat-label">Pace</div>
      <div class="stat-value pace">${paceStr} <span class="stat-unit">/${unit}</span></div>
    </div>`;

  document.getElementById('modalStats').innerHTML = statsHtml;

  const segNames = ['Start > CP1', 'CP1 > CP2', 'CP2 > End'];
  let splitsHtml = '<h3>Segment Splits</h3>';
  for (let i = 0; i < 3; i++) {
    const sd = segmentDistances[i] || 0;
    const st = segmentTimes[i] || 0;
    const segDist = useMetric ? (sd / 1000).toFixed(2) + ' ' + unit : (sd / 1609.34).toFixed(2) + ' ' + unit;
    splitsHtml += `
      <div class="split-row">
        <span class="split-label">${segNames[i]}</span>
        <span class="split-value">${segDist} | ${formatTime(st)}</span>
      </div>`;
  }
  document.getElementById('modalSplits').innerHTML = splitsHtml;

  document.getElementById('summaryModal').classList.add('show');
}

function saveRun() {
  if (!completedRunData) return;
  const runs = JSON.parse(localStorage.getItem('runtracker_runs') || '[]');
  runs.unshift(completedRunData);
  localStorage.setItem('runtracker_runs', JSON.stringify(runs));
  completedRunData = null;
  document.getElementById('summaryModal').classList.remove('show');
  resetRunState();
}

function discardRun() {
  completedRunData = null;
  document.getElementById('summaryModal').classList.remove('show');
  resetRunState();
}

function resetRunState() {
  if (trailLine) { runMap.removeLayer(trailLine); trailLine = null; }
  if (runnerMarker) { runMap.removeLayer(runnerMarker); runnerMarker = null; }
  totalDistance = 0;
  currentSpeed = 0;
  gpsTrail = [];
  updateRunControls();

  document.getElementById('curSpeed').innerHTML = '0.0<span class="stat-unit">km/h</span>';
  document.getElementById('avgSpeed').innerHTML = '0.0<span class="stat-unit">km/h</span>';
  document.getElementById('runDist').innerHTML = '0.00<span class="stat-unit">km</span>';
  document.getElementById('runPace').innerHTML = '--:--<span class="stat-unit">/km</span>';
  document.getElementById('runTime').textContent = '00:00:00';
}

// =============================================
// HISTORY
// =============================================
function renderHistory() {
  const runs = JSON.parse(localStorage.getItem('runtracker_runs') || '[]');
  const listEl = document.getElementById('historyList');
  const emptyEl = document.getElementById('historyEmpty');

  if (runs.length === 0) {
    emptyEl.style.display = '';
    listEl.innerHTML = '';
    return;
  }

  emptyEl.style.display = 'none';
  const unit = useMetric ? 'km' : 'mi';
  const speedUnit = useMetric ? 'km/h' : 'mph';

  listEl.innerHTML = runs.map((run, idx) => {
    const d = new Date(run.date);
    const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    const dist = useMetric ? (run.distanceM / 1000).toFixed(2) : (run.distanceM / 1609.34).toFixed(2);
    const avgSpd = run.avgSpeed.toFixed(1);

    const segNames = ['Start>CP1', 'CP1>CP2', 'CP2>End'];
    let splitsHtml = '';
    if (run.segments) {
      splitsHtml = `<div class="run-card-splits"><h4>Splits</h4>`;
      run.segments.forEach((seg, i) => {
        const sd = useMetric ? (seg.distance / 1000).toFixed(2) : (seg.distance / 1609.34).toFixed(2);
        splitsHtml += `<div class="split-row"><span class="split-label">${segNames[i]}</span><span class="split-value">${sd} ${unit} | ${formatTime(seg.time)}</span></div>`;
      });
      splitsHtml += `</div>`;
    }

    return `
      <div class="run-card">
        <div class="run-card-header">
          <span class="run-card-date">${dateStr}</span>
          <button class="run-card-delete" onclick="deleteRun(${idx})" title="Delete">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
          </button>
        </div>
        <div class="run-card-stats">
          <div><div class="run-card-stat-label">Distance</div><div class="run-card-stat-value" style="color:var(--orange)">${dist} ${unit}</div></div>
          <div><div class="run-card-stat-label">Time</div><div class="run-card-stat-value" style="color:var(--blue)">${formatTime(run.elapsed)}</div></div>
          <div><div class="run-card-stat-label">Avg Speed</div><div class="run-card-stat-value" style="color:var(--accent)">${avgSpd} ${speedUnit}</div></div>
        </div>
        ${splitsHtml}
      </div>`;
  }).join('');
}

function deleteRun(idx) {
  if (!confirm('Delete this run?')) return;
  const runs = JSON.parse(localStorage.getItem('runtracker_runs') || '[]');
  runs.splice(idx, 1);
  localStorage.setItem('runtracker_runs', JSON.stringify(runs));
  renderHistory();
}

// =============================================
// UNIT TOGGLE
// =============================================
function toggleUnits() {
  useMetric = !useMetric;
  document.getElementById('unitToggle').textContent = useMetric ? 'km' : 'mi';
  updateRouteDisplay();
  if (runState !== 'idle') updateRunDisplay();
}

// =============================================
// INIT
// =============================================
document.addEventListener('DOMContentLoaded', () => {
  initMaps();
  updateWaypointUI();
  locateUser();
});
</script>
</body>
</html>
